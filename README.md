# Event-Driven Image Processing using AWS CDK

This sample code deploys event-driven image resizing solution in the Amazon Web Services (AWS) Cloud using the AWS Cloud Development Kit (AWS CDK). The project leverages Python CDK for infrastructure setup, and React based SPA application for frontend. It deploys an environment based on a simple design pattern required for upload, processing, and storage of image files.

## Architecture

![Reference Architecture](/assets/architecture.png)

1. User uploads image file from a SPA, served via Amazon CloudFront and an Amazon S3 web content bucket. The website sends the uploaded image via the Amazon API Gateway REST endpoint.

2. AWS Lambda REST function delivers the image to the Amazon S3 source bucket.

3. Upload of the image file to the S3 source bucket triggers Amazon EventBridge.

4. EventBridge triggers a photo processing Lambda function, which resizes the image in the source bucket to create thumbnails and places them in the S3 target bucket. 

5. The Lambda function reports metadata to Amazon DynamoDB.

6. The web browser sends a request to API Gateway, which routes the request to the REST Lambda function.

7. The Lambda function queries DynamoDB for image file details and returns the image path and name to the browser.

8. The browser retrieves the newly generated thumbnails from the target S3 bucket via CloudFront.

## Setup

### Prerequisite

- Node.js
- Python3

Install `cdk` as a development dependency, using NPM. 
```
$ npm install
```

> Note: This allows easy process to update `cdk` to latest version

To manually create a virtualenv on MacOS and Linux:

```
$ python3 -m venv .venv
```

After the init process completes and the virtualenv is created, you can use the following
step to activate your virtualenv.

```
$ source .venv/bin/activate
```

If you are a Windows platform, you would activate the virtualenv like this:

```
% .venv\Scripts\activate.bat
```

Once the virtualenv is activated, you can install the required dependencies.

```
$ pip install -r requirements.txt
```

At this point you can now synthesize the CloudFormation template for this code.

```
$ npx cdk synth
```

You can either use the CloudFormation template generated by this CDK application under `cdk.out` folder and deploy via AWS CloudFormation service using AWS Management Console or you can use use `cdk` cli to deploy the CDK application.

Before you deploy, make sure your environment (AWS Account + Region) is bootstrap for CDK deployment.

```
$ npx cdk bootstrap
```

Once you environment is bootstrapped, you can deploy.
```
$ npx cdk deploy --all
```

This will deploy two stack in your environment
```
backend -- responsible for the REST API and EventBridge Integration
frontend -- responsible for deploying the React frontend
```

## Cleanup

```
$ npx cdk destroy --all
```

Note: You have to manually delete the S3 buckets and objects to avoid any accidental file deletion.

## Security

See [CONTRIBUTING](CONTRIBUTING.md#security-issue-notifications) for more information.

## License

This library is licensed under the MIT-0 License. See the [LICENSE](LICENSE) file.

